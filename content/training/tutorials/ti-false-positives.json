{
  "id": "ti-false-positives",
  "type": "tutorial",
  "title": "Managing False Positives",
  "description": "Build allowlists, tune TI-based detections using confidence scores, implement feedback loops to improve intelligence quality, and document exceptions properly.",
  "category": "threat-intel",
  "difficulty": "advanced",
  "duration": "20 min",
  "tags": ["threat-intel", "false-positives", "tuning", "allowlist", "advanced"],
  "objectives": [
    "Build and maintain allowlists for false positive reduction",
    "Tune detections based on confidence scores",
    "Implement feedback loops for continuous improvement",
    "Document exceptions with proper justification"
  ],
  "content": {
    "sections": [
      {
        "title": "The False Positive Challenge",
        "body": "<p>TI-based detections inevitably produce false positives. Common causes:</p><h4>Why False Positives Occur</h4><table><tr><th>Cause</th><th>Example</th></tr><tr><td>Shared infrastructure</td><td>CDN IP flagged because attacker also uses it</td></tr><tr><td>Stale intelligence</td><td>Domain now sinkholed or legitimately purchased</td></tr><tr><td>Low confidence indicators</td><td>Community-reported IOC with minimal validation</td></tr><tr><td>Generic patterns</td><td>Common file name flagged as malware</td></tr><tr><td>Legitimate services</td><td>Security tool communicating with known-bad for research</td></tr></table><h4>Impact of False Positives</h4><ul><li>Alert fatigue for analysts</li><li>Missed real threats buried in noise</li><li>Loss of trust in TI program</li><li>Wasted investigation time</li></ul>"
      },
      {
        "title": "Allowlist Architecture",
        "body": "<h4>Allowlist Lookup Structure</h4><pre><code>indicator,type,reason,approved_by,approved_date,expiration\n8.8.8.8,ip,Google DNS,jsmith,2024-01-15,2025-01-15\n*.google.com,domain,Google services,jsmith,2024-01-15,2025-01-15\nlegit-scanner.security.com,domain,Authorized scanner,admin,2024-01-10,2024-07-10</code></pre><h4>Required Allowlist Fields</h4><table><tr><th>Field</th><th>Purpose</th></tr><tr><td>indicator</td><td>The allowlisted value</td></tr><tr><td>type</td><td>ip, domain, hash, etc.</td></tr><tr><td>reason</td><td>Why this is allowlisted</td></tr><tr><td>approved_by</td><td>Who approved the exception</td></tr><tr><td>approved_date</td><td>When it was approved</td></tr><tr><td>expiration</td><td>When to review/remove</td></tr></table><h4>Optional Fields</h4><ul><li><code>ticket_id</code>: Reference to approval ticket</li><li><code>scope</code>: Where allowlist applies (all, specific sourcetype)</li><li><code>original_threat_type</code>: What TI category triggered this</li></ul>"
      },
      {
        "title": "Implementing Allowlists",
        "body": "<h4>Basic Allowlist Application</h4><pre><code>index=firewall\n| lookup threat_intel indicator as dest_ip OUTPUT threat_type\n| lookup allowlist indicator as dest_ip OUTPUT reason as allowlist_reason\n| where isnotnull(threat_type) AND isnull(allowlist_reason)\n| table _time, src_ip, dest_ip, threat_type</code></pre><h4>Allowlist with Logging</h4><pre><code>index=firewall\n| lookup threat_intel indicator as dest_ip OUTPUT threat_type\n| lookup allowlist indicator as dest_ip OUTPUT reason as allowlist_reason\n| eval alert_status = case(\n    isnull(threat_type), \"clean\",\n    isnotnull(allowlist_reason), \"allowlisted\",\n    true(), \"alert\")\n| where alert_status != \"clean\"\n| table _time, src_ip, dest_ip, threat_type, alert_status, allowlist_reason</code></pre><h4>Wildcard Allowlist</h4><p>For domain patterns, use WILDCARD match_type:</p><pre><code>indicator,type,reason\n*.googleapis.com,domain,Google APIs\n*.windowsupdate.com,domain,Windows Update\n*.office365.com,domain,Microsoft 365</code></pre><h4>CIDR Allowlist</h4><pre><code>indicator,type,reason\n8.8.8.0/24,ip,Google DNS range\n13.0.0.0/8,ip,Microsoft Azure</code></pre>"
      },
      {
        "title": "Confidence-Based Tuning",
        "body": "<h4>Alert Thresholds by Confidence</h4><pre><code>index=firewall\n| lookup threat_intel indicator as dest_ip OUTPUT threat_type, confidence\n| where isnotnull(threat_type)\n| eval alert_level = case(\n    confidence >= 80, \"high_priority\",\n    confidence >= 50, \"medium_priority\",\n    confidence >= 20, \"low_priority\",\n    true(), \"informational\")\n| where alert_level IN (\"high_priority\", \"medium_priority\")\n| table _time, src_ip, dest_ip, threat_type, confidence, alert_level</code></pre><h4>Different Actions by Confidence</h4><pre><code>| eval action = case(\n    confidence >= 80, \"alert_and_block\",\n    confidence >= 50, \"alert_only\",\n    confidence >= 20, \"log_for_hunting\",\n    true(), \"enrich_only\")</code></pre><h4>Confidence Boost from Multiple Sources</h4><pre><code>| lookup feed_a indicator as dest_ip OUTPUT confidence as conf_a\n| lookup feed_b indicator as dest_ip OUTPUT confidence as conf_b\n| lookup internal_ti indicator as dest_ip OUTPUT confidence as conf_internal\n| eval combined_confidence = max(conf_a, conf_b, conf_internal)\n| eval multi_source = if(mvcount(mvappend(conf_a, conf_b, conf_internal)) > 1, \"yes\", \"no\")\n| eval adjusted_confidence = if(multi_source=\"yes\", min(combined_confidence + 20, 100), combined_confidence)</code></pre>"
      },
      {
        "title": "Contextual Filtering",
        "body": "<h4>Filter by Asset Type</h4><pre><code>index=firewall\n| lookup threat_intel indicator as dest_ip OUTPUT threat_type\n| lookup asset_inventory ip as src_ip OUTPUT asset_type\n| where isnotnull(threat_type)\n| eval suppress = case(\n    asset_type=\"security_scanner\", \"yes\",\n    asset_type=\"threat_research\", \"yes\",\n    true(), \"no\")\n| where suppress=\"no\"</code></pre><h4>Filter by User Role</h4><pre><code>index=proxy\n| lookup threat_intel indicator as dest OUTPUT threat_type\n| lookup user_directory user OUTPUT department, role\n| where isnotnull(threat_type)\n| eval suppress = if(role=\"security_researcher\", \"yes\", \"no\")\n| where suppress=\"no\"</code></pre><h4>Time-Based Suppression</h4><pre><code>| eval hour = strftime(_time, \"%H\")\n| eval suppress = if(hour >= \"02\" AND hour <= \"04\", \"maintenance_window\", \"no\")\n| where suppress=\"no\"</code></pre><h4>Volume-Based Suppression</h4><pre><code>| eventstats count as hit_count by dest_ip\n| where hit_count < 1000</code></pre><p>Suppress extremely high-volume hits that are likely infrastructure.</p>"
      },
      {
        "title": "Feedback Loop Implementation",
        "body": "<h4>Track Alert Outcomes</h4><pre><code>| inputlookup ti_alert_outcomes.csv\n| stats count as total, \n    count(eval(outcome=\"true_positive\")) as tp,\n    count(eval(outcome=\"false_positive\")) as fp,\n    count(eval(outcome=\"pending\")) as pending\n    by indicator, threat_type\n| eval fp_rate = round(fp / total * 100, 1)\n| where fp_rate > 50\n| sort - fp_rate</code></pre><h4>Outcome Tracking Lookup</h4><pre><code>alert_id,indicator,threat_type,outcome,analyst,resolution_date,notes\nALERT-001,192.168.50.100,c2,true_positive,jsmith,2024-01-15,\"Confirmed malware C2\"\nALERT-002,8.8.8.8,suspicious,false_positive,jsmith,2024-01-15,\"Google DNS - allowlisted\"</code></pre><h4>Automated FP Detection</h4><pre><code>index=firewall\n| lookup threat_intel indicator as dest_ip OUTPUT threat_type\n| where isnotnull(threat_type)\n| stats dc(src_ip) as unique_sources, count as total_hits by dest_ip, threat_type\n| where unique_sources > 100 AND total_hits > 1000\n| eval likely_fp = \"High volume from many sources - review for FP\"</code></pre><h4>Feed Quality Metrics</h4><pre><code>| inputlookup ti_alert_outcomes.csv\n| lookup threat_intel indicator OUTPUT source as ti_source\n| stats \n    count as total,\n    count(eval(outcome=\"true_positive\")) as tp,\n    count(eval(outcome=\"false_positive\")) as fp\n    by ti_source\n| eval tp_rate = round(tp / total * 100, 1)\n| sort - tp_rate</code></pre>"
      },
      {
        "title": "Exception Documentation",
        "body": "<h4>Exception Request Template</h4><pre><code>## Allowlist Exception Request\n\n**Indicator**: 8.8.8.8\n**Type**: IP Address\n**Current Classification**: suspicious_dns\n**Feed Source**: community_feed_x\n\n**Reason for Exception**:\nGoogle Public DNS server. Legitimate infrastructure used by organization.\n\n**Evidence**:\n- IP owned by Google (WHOIS verification)\n- Used by 95% of internal hosts\n- No malicious activity observed in 30-day review\n\n**Scope**: All security monitoring\n**Requested By**: jsmith\n**Approved By**: security_manager\n**Expiration**: 2025-01-15 (annual review)\n**Ticket**: SEC-12345</code></pre><h4>Bulk Exception Processing</h4><pre><code>| inputlookup pending_exceptions.csv\n| where status=\"approved\"\n| table indicator, type, reason, approved_by, expiration\n| outputlookup append=t allowlist.csv</code></pre><h4>Exception Audit Trail</h4><pre><code>| inputlookup allowlist.csv\n| eval days_to_expiration = (strptime(expiration, \"%Y-%m-%d\") - now()) / 86400\n| where days_to_expiration < 30\n| table indicator, reason, approved_by, expiration, days_to_expiration</code></pre>"
      },
      {
        "title": "Allowlist Hygiene",
        "body": "<h4>Find Expired Exceptions</h4><pre><code>| inputlookup allowlist.csv\n| where strptime(expiration, \"%Y-%m-%d\") < now()\n| table indicator, type, reason, expiration, approved_by</code></pre><h4>Find Unused Allowlist Entries</h4><pre><code>| inputlookup allowlist.csv\n| map maxsearches=500 search=\"index=firewall dest_ip=$indicator$ earliest=-30d | stats count | eval indicator=\\\"$indicator$\\\"\"\n| where count = 0\n| table indicator</code></pre><h4>Allowlist Growth Monitoring</h4><pre><code>| inputlookup allowlist.csv\n| eval month = strftime(strptime(approved_date, \"%Y-%m-%d\"), \"%Y-%m\")\n| stats count by month\n| sort month</code></pre><h4>Scheduled Allowlist Review</h4><pre><code>| inputlookup allowlist.csv\n| eval review_due = case(\n    strptime(expiration, \"%Y-%m-%d\") < now(), \"expired\",\n    strptime(expiration, \"%Y-%m-%d\") < relative_time(now(), \"+30d\"), \"review_soon\",\n    true(), \"current\")\n| stats count by review_due</code></pre>"
      },
      {
        "title": "Tuning Workflow",
        "body": "<h4>Step 1: Identify High-FP Indicators</h4><pre><code>| inputlookup ti_alert_outcomes.csv\n| where outcome=\"false_positive\"\n| stats count by indicator, threat_type\n| sort - count\n| head 20</code></pre><h4>Step 2: Analyze the Indicator</h4><pre><code>| makeresults\n| eval indicator=\"suspicious_ip\"\n| lookup whois_cache indicator OUTPUT org, country, asn\n| lookup threat_intel indicator OUTPUT source, first_seen, last_seen, confidence</code></pre><h4>Step 3: Decide Action</h4><ul><li><strong>Allowlist</strong>: Legitimate infrastructure, well-documented</li><li><strong>Lower confidence</strong>: Notify feed provider, adjust local score</li><li><strong>Remove from feed</strong>: Invalid IOC, should be removed</li><li><strong>Keep alerting</strong>: Still valuable despite some FPs</li></ul><h4>Step 4: Implement and Document</h4><pre><code>| makeresults\n| eval indicator=\"8.8.8.8\", type=\"ip\", reason=\"Google DNS\", approved_by=\"analyst\", approved_date=strftime(now(), \"%Y-%m-%d\"), expiration=strftime(relative_time(now(), \"+1y\"), \"%Y-%m-%d\")\n| outputlookup append=t allowlist.csv</code></pre>"
      },
      {
        "title": "Summary",
        "body": "<p>Key false positive management techniques:</p><ul><li><strong>Allowlists</strong>: Structured exceptions with expiration and documentation</li><li><strong>Confidence tuning</strong>: Different alert thresholds by confidence level</li><li><strong>Contextual filtering</strong>: Suppress based on asset type, user role, time</li><li><strong>Feedback loops</strong>: Track outcomes to identify problematic indicators</li><li><strong>Feed metrics</strong>: Measure quality by source to inform feed selection</li><li><strong>Regular hygiene</strong>: Review and expire stale allowlist entries</li></ul><p>Effective FP management balances detection coverage with alert quality to maintain analyst trust in TI-based detections.</p>"
      }
    ]
  }
}
