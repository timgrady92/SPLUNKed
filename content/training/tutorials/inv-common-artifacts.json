{
  "id": "inv-common-artifacts",
  "type": "tutorial",
  "title": "Common Investigation Artifacts",
  "description": "Identify and analyze key evidence artifacts including registry modifications, scheduled tasks, service installations, and file system changes that reveal attacker persistence and techniques.",
  "category": "investigation",
  "difficulty": "intermediate",
  "duration": "20 min",
  "tags": ["investigation", "artifacts", "persistence", "forensics", "intermediate"],
  "objectives": [
    "Identify common persistence artifacts in logs",
    "Analyze registry, scheduled task, and service changes",
    "Detect file system indicators of compromise",
    "Build queries for artifact collection"
  ],
  "content": {
    "sections": [
      {
        "title": "What Are Investigation Artifacts?",
        "body": "<p>Artifacts are traces left by attacker activity. They reveal:</p><ul><li>How the attacker gained persistence</li><li>What tools they used</li><li>What data they accessed</li><li>Where they've been in your environment</li></ul><h4>Categories of Artifacts</h4><ul><li><strong>Registry</strong> - Configuration changes, autoruns</li><li><strong>Scheduled Tasks</strong> - Persistence mechanisms</li><li><strong>Services</strong> - Malicious service installation</li><li><strong>File System</strong> - Dropped files, modified executables</li><li><strong>Network</strong> - DNS cache, connection history</li></ul>"
      },
      {
        "title": "Registry Artifacts",
        "body": "<p>The Windows registry stores persistence mechanisms attackers use.</p><h4>Run Keys (Autostart)</h4><pre><code>index=sysmon EventCode=13\n| search TargetObject IN (\n    \"*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run*\",\n    \"*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce*\"\n)\n| table _time, User, TargetObject, Details</code></pre><h4>Detecting New Run Entries</h4><pre><code>index=security EventCode=4657 ObjectName=\"*CurrentVersion\\\\Run*\"\n| table _time, SubjectUserName, ObjectName, ObjectValueName, NewValue</code></pre><h4>Common Malicious Registry Locations</h4><pre><code>index=sysmon EventCode=13\n| search TargetObject IN (\n    \"*\\\\CurrentVersion\\\\Run*\",\n    \"*\\\\Services\\\\*\",\n    \"*\\\\Winlogon\\\\Shell*\",\n    \"*\\\\Winlogon\\\\Userinit*\",\n    \"*\\\\Environment\\\\UserInitMprLogonScript*\",\n    \"*\\\\Image File Execution Options\\\\*\"\n)\n| stats count by TargetObject, Details\n| sort - count</code></pre><h4>Registry Modification Timeline</h4><pre><code>index=sysmon EventCode=13 User!=\"SYSTEM\"\n| timechart span=1h count by User</code></pre>"
      },
      {
        "title": "Scheduled Task Artifacts",
        "body": "<p>Scheduled tasks are a common persistence and execution mechanism.</p><h4>Task Creation Events</h4><pre><code>index=security EventCode=4698\n| table _time, SubjectUserName, TaskName, TaskContent</code></pre><h4>Sysmon Task Creation</h4><pre><code>index=sysmon EventCode=1 Image=\"*schtasks*\"\n| search CommandLine IN (\"*/create*\", \"*/change*\")\n| table _time, User, CommandLine</code></pre><h4>Suspicious Task Patterns</h4><pre><code>index=security EventCode=4698\n| eval suspicious = case(\n    match(TaskContent, \"(?i)powershell.*-enc\"), \"Encoded PowerShell\",\n    match(TaskContent, \"(?i)cmd.*/c\"), \"Command execution\",\n    match(TaskContent, \"(?i)http|ftp\"), \"Network activity\",\n    match(TaskContent, \"(?i)\\\\temp\\\\\"), \"Temp directory execution\",\n    true(), null())\n| where isnotnull(suspicious)\n| table _time, TaskName, suspicious, SubjectUserName</code></pre><h4>Task Deletion (Covering Tracks)</h4><pre><code>index=security EventCode=4699\n| table _time, SubjectUserName, TaskName</code></pre><h4>Short-Lived Tasks</h4><pre><code>index=security EventCode IN (4698, 4699)\n| transaction TaskName maxspan=24h\n| where eventcount > 1\n| eval lifetime_hours = duration / 3600\n| where lifetime_hours < 1\n| table TaskName, lifetime_hours, SubjectUserName</code></pre>"
      },
      {
        "title": "Service Artifacts",
        "body": "<p>Services provide persistent execution with SYSTEM privileges.</p><h4>Service Installation</h4><pre><code>index=security EventCode=4697\n| table _time, SubjectUserName, ServiceName, ServiceFileName, ServiceType</code></pre><h4>Sysmon Service Driver Load</h4><pre><code>index=sysmon EventCode=6\n| table _time, ImageLoaded, Hashes, Signed, Signature</code></pre><h4>Suspicious Service Characteristics</h4><pre><code>index=security EventCode=4697\n| eval suspicious = case(\n    match(ServiceFileName, \"(?i)\\\\temp\\\\\"), \"Temp directory\",\n    match(ServiceFileName, \"(?i)\\\\users\\\\\"), \"User profile\",\n    match(ServiceFileName, \"(?i)powershell\"), \"PowerShell service\",\n    match(ServiceFileName, \"(?i)cmd\"), \"CMD service\",\n    NOT match(ServiceFileName, \"(?i)^(c:\\\\windows|c:\\\\program files)\"), \"Unusual path\",\n    true(), null())\n| where isnotnull(suspicious)\n| table _time, ServiceName, ServiceFileName, suspicious</code></pre><h4>Service State Changes</h4><pre><code>index=security EventCode=7045 OR (index=sysmon EventCode=1 Image=\"*sc.exe*\")\n| table _time, User, ServiceName, CommandLine</code></pre>"
      },
      {
        "title": "File System Artifacts",
        "body": "<p>File creation and modification events reveal attacker tools and staging.</p><h4>Sysmon File Creation</h4><pre><code>index=sysmon EventCode=11\n| table _time, User, Image, TargetFilename</code></pre><h4>Suspicious File Locations</h4><pre><code>index=sysmon EventCode=11\n| search TargetFilename IN (\n    \"*\\\\Windows\\\\Temp\\\\*\",\n    \"*\\\\Users\\\\Public\\\\*\",\n    \"*\\\\ProgramData\\\\*\",\n    \"*\\\\AppData\\\\Local\\\\Temp\\\\*\"\n)\n| search TargetFilename IN (\"*.exe\", \"*.dll\", \"*.ps1\", \"*.bat\", \"*.vbs\")\n| table _time, User, Image, TargetFilename</code></pre><h4>Executable Drops from Office</h4><pre><code>index=sysmon EventCode=11\n| search Image IN (\"*\\\\WINWORD.EXE\", \"*\\\\EXCEL.EXE\", \"*\\\\OUTLOOK.EXE\")\n| search TargetFilename IN (\"*.exe\", \"*.dll\", \"*.js\", \"*.vbs\", \"*.ps1\")\n| table _time, User, Image, TargetFilename</code></pre><h4>File Stream Creation (ADS)</h4><pre><code>index=sysmon EventCode=15\n| table _time, User, TargetFilename, Contents</code></pre><p>Alternate Data Streams can hide malicious content.</p>"
      },
      {
        "title": "Network Artifacts",
        "body": "<h4>DNS Query Cache</h4><pre><code>index=dns src_ip=\"compromised_host\"\n| stats count, earliest(_time) as first_query, latest(_time) as last_query by query\n| sort - count</code></pre><h4>Outbound Connection History</h4><pre><code>index=sysmon EventCode=3 src_ip=\"compromised_host\"\n| stats count, values(DestinationPort) as ports by DestinationIp\n| sort - count</code></pre><h4>New Destinations</h4><pre><code>index=sysmon EventCode=3 src_ip=\"compromised_host\" earliest=-1d\n| stats min(_time) as first_seen by DestinationIp\n| join type=left DestinationIp [\n    search index=sysmon EventCode=3 src_ip=\"compromised_host\" earliest=-30d latest=-1d\n    | stats count by DestinationIp\n]\n| where isnull(count)\n| table first_seen, DestinationIp</code></pre><h4>Process Network Activity</h4><pre><code>index=sysmon EventCode=3 src_ip=\"compromised_host\"\n| stats count, dc(DestinationIp) as unique_dest, dc(DestinationPort) as unique_ports by Image\n| sort - count</code></pre>"
      },
      {
        "title": "User Account Artifacts",
        "body": "<h4>Account Creation</h4><pre><code>index=security EventCode=4720\n| table _time, SubjectUserName, TargetUserName, dest</code></pre><h4>Account Modifications</h4><pre><code>index=security EventCode IN (4738, 4732, 4733)\n| eval change_type = case(\n    EventCode=4738, \"Account Modified\",\n    EventCode=4732, \"Added to Group\",\n    EventCode=4733, \"Removed from Group\")\n| table _time, SubjectUserName, TargetUserName, change_type</code></pre><h4>Privilege Assignments</h4><pre><code>index=security EventCode=4728\n| search TargetUserName IN (\"Domain Admins\", \"Administrators\", \"Enterprise Admins\")\n| table _time, SubjectUserName, MemberName, TargetUserName</code></pre><h4>Account Lifecycle Anomalies</h4><pre><code>index=security EventCode IN (4720, 4726)\n| eval action = if(EventCode=4720, \"created\", \"deleted\")\n| transaction TargetUserName maxspan=7d\n| where eventcount > 1\n| table TargetUserName, duration, eventcount</code></pre><p>Accounts created and quickly deleted are suspicious.</p>"
      },
      {
        "title": "Artifact Collection Queries",
        "body": "<h4>Complete Artifact Sweep</h4><pre><code>index=security OR index=sysmon earliest=-7d\n| search EventCode IN (\n    4720, 4726, 4728, 4732, 4733,\n    4697, 4698, 4699,\n    4657,\n    1, 3, 6, 7, 11, 13, 15\n)\n| eval artifact_type = case(\n    EventCode IN (4720, 4726, 4728, 4732, 4733), \"Account\",\n    EventCode IN (4697), \"Service\",\n    EventCode IN (4698, 4699), \"Scheduled Task\",\n    EventCode IN (4657), \"Registry\",\n    EventCode IN (1), \"Process\",\n    EventCode IN (3), \"Network\",\n    EventCode IN (6, 7), \"Driver/DLL\",\n    EventCode IN (11, 15), \"File\",\n    EventCode IN (13), \"Registry (Sysmon)\",\n    true(), \"Other\")\n| stats count by artifact_type, EventCode\n| sort artifact_type</code></pre><h4>Host-Specific Artifact Collection</h4><pre><code>index=* host=\"compromised_host\" earliest=-24h\n| eval artifact_category = case(\n    match(_raw, \"(?i)schtasks|taskeng|4698|4699\"), \"Scheduled Task\",\n    match(_raw, \"(?i)service|4697|sc.exe\"), \"Service\",\n    match(_raw, \"(?i)registry|4657|EventCode=13\"), \"Registry\",\n    match(_raw, \"(?i)4720|4726|account\"), \"Account\",\n    true(), null())\n| where isnotnull(artifact_category)\n| stats count by artifact_category\n| sort - count</code></pre><h4>Persistence Summary</h4><pre><code>index=security OR index=sysmon earliest=-7d\n| search EventCode IN (4697, 4698, 13)\n| eval persistence_type = case(\n    EventCode=4697, \"Service: \" . ServiceName,\n    EventCode=4698, \"Task: \" . TaskName,\n    EventCode=13 AND match(TargetObject, \"Run\"), \"Registry Run Key\",\n    true(), \"Other\")\n| stats count, earliest(_time) as first_seen by persistence_type\n| sort first_seen</code></pre>"
      },
      {
        "title": "Artifact Investigation Workflow",
        "body": "<h4>Step 1: Identify Timeframe</h4><p>Determine when compromise likely occurred:</p><pre><code>index=security EventCode=4624 dest=\"compromised_host\" Logon_Type IN (3, 10)\n| stats earliest(_time) as first_suspicious by src_ip, user\n| sort first_suspicious</code></pre><h4>Step 2: Collect Persistence Artifacts</h4><pre><code>index=* host=\"compromised_host\" earliest=\"$first_suspicious$\"\n| search EventCode IN (4697, 4698, 13)\n| table _time, EventCode, TaskName, ServiceName, TargetObject</code></pre><h4>Step 3: Identify Dropped Files</h4><pre><code>index=sysmon EventCode=11 host=\"compromised_host\" earliest=\"$first_suspicious$\"\n| search TargetFilename IN (\"*.exe\", \"*.dll\", \"*.ps1\")\n| table _time, Image, TargetFilename</code></pre><h4>Step 4: Check Network IOCs</h4><pre><code>index=sysmon EventCode=3 host=\"compromised_host\" earliest=\"$first_suspicious$\"\n| stats count, values(Image) as processes by DestinationIp, DestinationPort\n| lookup threat_intel DestinationIp as indicator OUTPUT category\n| where isnotnull(category)\n| table DestinationIp, DestinationPort, category, processes</code></pre><h4>Step 5: Export Evidence</h4><pre><code>| outputcsv artifact_collection_case12345.csv</code></pre>"
      },
      {
        "title": "Summary",
        "body": "<p>Key investigation artifacts and their sources:</p><ul><li><strong>Registry (4657, Sysmon 13)</strong> - Run keys, services, shell extensions</li><li><strong>Scheduled Tasks (4698, 4699)</strong> - Persistence and execution</li><li><strong>Services (4697)</strong> - Persistent SYSTEM-level access</li><li><strong>File System (Sysmon 11, 15)</strong> - Dropped tools, scripts, ADS</li><li><strong>Network (Sysmon 3)</strong> - C2 connections, exfiltration</li><li><strong>Accounts (4720, 4732)</strong> - Backdoor accounts, privilege escalation</li></ul><p>Systematic artifact collection ensures no evidence is missed and provides the foundation for complete incident documentation.</p>"
      }
    ]
  }
}
