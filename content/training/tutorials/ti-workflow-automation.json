{
  "id": "ti-workflow-automation",
  "type": "tutorial",
  "title": "TI Workflow Automation",
  "description": "Automate threat intelligence workflows including IOC ingestion, alert enrichment, prioritization based on TI context, and metrics tracking for program effectiveness.",
  "category": "threat-intel",
  "difficulty": "advanced",
  "duration": "20 min",
  "tags": ["threat-intel", "automation", "workflow", "metrics", "advanced"],
  "objectives": [
    "Automate IOC ingestion and processing",
    "Enrich alerts with threat intelligence context",
    "Prioritize alerts based on TI severity and confidence",
    "Track TI program effectiveness metrics"
  ],
  "content": {
    "sections": [
      {
        "title": "TI Workflow Overview",
        "body": "<p>A mature TI program automates the flow from intelligence collection to detection and response.</p><h4>Workflow Stages</h4><ol><li><strong>Collection</strong>: Gather IOCs from feeds and incidents</li><li><strong>Processing</strong>: Normalize, deduplicate, enrich</li><li><strong>Detection</strong>: Match against live data</li><li><strong>Enrichment</strong>: Add context to alerts</li><li><strong>Prioritization</strong>: Rank by severity and confidence</li><li><strong>Response</strong>: Route to appropriate workflow</li><li><strong>Feedback</strong>: Track outcomes, improve quality</li></ol><h4>Automation Benefits</h4><ul><li>Consistent processing of all intelligence</li><li>Faster time from IOC to detection</li><li>Reduced manual effort</li><li>Measurable program effectiveness</li></ul>"
      },
      {
        "title": "Automated IOC Ingestion",
        "body": "<h4>Scheduled Feed Collection</h4><pre><code># Scheduled search: ti_feed_collector (runs hourly)\n| inputcsv https://feed.example.com/iocs.csv\n| eval source=\"external_feed\", ingest_time=now()\n| eval first_seen=if(isnull(first_seen), strftime(now(), \"%Y-%m-%d\"), first_seen)\n| eval last_seen=strftime(now(), \"%Y-%m-%d\")\n| outputlookup append=t staging_iocs.csv</code></pre><h4>IOC Validation Pipeline</h4><pre><code># Scheduled search: ti_ioc_validator (runs after collector)\n| inputlookup staging_iocs.csv\n| eval valid = case(\n    type=\"ip\" AND match(indicator, \"^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$\"), 1,\n    type=\"domain\" AND match(indicator, \"^[a-zA-Z0-9][a-zA-Z0-9.-]+$\"), 1,\n    type=\"hash\" AND match(indicator, \"^[a-fA-F0-9]{32,64}$\"), 1,\n    true(), 0)\n| where valid=1\n| lookup allowlist.csv indicator OUTPUT allowlist_reason\n| where isnull(allowlist_reason)\n| outputlookup validated_iocs.csv</code></pre><h4>Master Lookup Update</h4><pre><code># Scheduled search: ti_master_update (runs after validation)\n| inputlookup validated_iocs.csv\n| append [| inputlookup internal_iocs.csv]\n| stats \n    max(confidence) as confidence,\n    values(source) as sources,\n    min(first_seen) as first_seen,\n    max(last_seen) as last_seen,\n    values(category) as categories\n    by indicator, type\n| outputlookup master_threat_intel.csv</code></pre>"
      },
      {
        "title": "Alert Enrichment Pipeline",
        "body": "<h4>Enrichment on Alert Creation</h4><pre><code># Alert action or correlation search enrichment\nindex=notable\n| lookup master_threat_intel.csv indicator as dest_ip OUTPUT \n    threat_type, confidence as ti_confidence, sources as ti_sources, categories as ti_categories\n| lookup master_threat_intel.csv indicator as src_ip OUTPUT \n    threat_type as src_threat, confidence as src_ti_confidence\n| lookup geoip ip as src_ip OUTPUT country as src_country, city as src_city\n| lookup asset_inventory ip as dest_ip OUTPUT asset_type, criticality, owner\n| lookup user_directory user OUTPUT department, manager, is_privileged</code></pre><h4>Multi-Layer Enrichment</h4><pre><code>| eval ti_matched = if(isnotnull(threat_type) OR isnotnull(src_threat), \"yes\", \"no\")\n| eval ti_context = case(\n    isnotnull(threat_type) AND isnotnull(src_threat), \"bidirectional_threat\",\n    isnotnull(threat_type), \"outbound_to_threat\",\n    isnotnull(src_threat), \"inbound_from_threat\",\n    true(), \"no_ti_match\")\n| eval asset_context = case(\n    criticality=\"critical\", \"critical_asset\",\n    criticality=\"high\", \"high_value_asset\",\n    true(), \"standard_asset\")\n| eval user_context = if(is_privileged=\"true\", \"privileged_user\", \"standard_user\")</code></pre><h4>Context Summary Field</h4><pre><code>| eval enrichment_summary = mvappend(\n    if(isnotnull(threat_type), \"TI:\" . threat_type . \" (\" . ti_confidence . \")\", null()),\n    if(isnotnull(src_country), \"Geo:\" . src_country, null()),\n    if(isnotnull(asset_type), \"Asset:\" . asset_type, null()),\n    if(is_privileged=\"true\", \"PrivUser\", null())\n)</code></pre>"
      },
      {
        "title": "TI-Based Prioritization",
        "body": "<h4>Priority Scoring Formula</h4><pre><code>| eval ti_score = case(\n    ti_confidence=\"high\", 30,\n    ti_confidence=\"medium\", 20,\n    ti_confidence=\"low\", 10,\n    true(), 0)\n| eval asset_score = case(\n    criticality=\"critical\", 30,\n    criticality=\"high\", 20,\n    criticality=\"medium\", 10,\n    true(), 0)\n| eval user_score = if(is_privileged=\"true\", 20, 0)\n| eval multi_source_bonus = if(mvcount(ti_sources) >= 2, 10, 0)\n| eval priority_score = ti_score + asset_score + user_score + multi_source_bonus\n| eval priority = case(\n    priority_score >= 70, \"critical\",\n    priority_score >= 50, \"high\",\n    priority_score >= 30, \"medium\",\n    true(), \"low\")</code></pre><h4>Automated Routing</h4><pre><code>| eval route_to = case(\n    priority=\"critical\", \"tier2_immediate\",\n    priority=\"high\", \"tier1_priority\",\n    priority=\"medium\", \"tier1_standard\",\n    priority=\"low\", \"automated_triage\")\n| eval sla_minutes = case(\n    priority=\"critical\", 15,\n    priority=\"high\", 60,\n    priority=\"medium\", 240,\n    true(), 1440)</code></pre><h4>Alert Suppression Logic</h4><pre><code>| eval suppress = case(\n    ti_confidence=\"low\" AND asset_score < 20, \"yes\",\n    isnotnull(allowlist_reason), \"yes\",\n    true(), \"no\")\n| where suppress=\"no\"</code></pre>"
      },
      {
        "title": "Automated Response Integration",
        "body": "<h4>SOAR Integration Fields</h4><pre><code>| eval soar_playbook = case(\n    threat_type=\"c2\" AND ti_confidence=\"high\", \"isolate_and_investigate\",\n    threat_type=\"phishing\", \"email_investigation\",\n    threat_type=\"malware\", \"malware_response\",\n    true(), \"standard_triage\")\n| eval soar_artifacts = mvappend(\n    \"ip:\" . dest_ip,\n    \"user:\" . user,\n    if(isnotnull(file_hash), \"hash:\" . file_hash, null())\n)\n| eval soar_context = \"{\\\"ti_sources\\\": \\\"\" . mvjoin(ti_sources, \",\") . \"\\\", \\\"confidence\\\": \\\"\" . ti_confidence . \"\\\"}\"</code></pre><h4>Webhook Alert Action</h4><pre><code># In savedsearches.conf\n[TI_High_Confidence_Alert]\nsearch = index=firewall | lookup master_threat_intel indicator as dest_ip OUTPUT threat_type, confidence | where confidence=\"high\"\nalert.severity = 4\naction.webhook = 1\naction.webhook.param.url = https://soar.example.com/api/alert</code></pre><h4>Blocking Recommendation</h4><pre><code>| eval block_recommendation = case(\n    ti_confidence=\"high\" AND threat_type IN (\"c2\", \"malware\"), \"immediate_block\",\n    ti_confidence=\"high\", \"review_for_block\",\n    ti_confidence=\"medium\" AND mvcount(ti_sources) >= 2, \"review_for_block\",\n    true(), \"monitor_only\")</code></pre>"
      },
      {
        "title": "TI Program Metrics",
        "body": "<h4>Detection Metrics Dashboard</h4><pre><code># IOC Hit Rate\n| inputlookup master_threat_intel.csv\n| stats count as total_iocs\n| appendcols [search index=firewall earliest=-24h | lookup master_threat_intel indicator as dest_ip OUTPUT threat_type | where isnotnull(threat_type) | stats dc(dest_ip) as iocs_matched]\n| eval hit_rate = round(iocs_matched / total_iocs * 100, 2)</code></pre><h4>Alert Volume by TI Source</h4><pre><code>index=notable ti_sources=*\n| mvexpand ti_sources\n| stats count as alerts by ti_sources\n| sort - alerts</code></pre><h4>True Positive Rate by Feed</h4><pre><code>| inputlookup ti_alert_outcomes.csv\n| lookup master_threat_intel indicator OUTPUT sources\n| mvexpand sources\n| stats \n    count as total,\n    count(eval(outcome=\"true_positive\")) as tp,\n    count(eval(outcome=\"false_positive\")) as fp\n    by sources\n| eval tp_rate = round(tp / total * 100, 1)\n| sort - tp_rate</code></pre><h4>Mean Time to Detect</h4><pre><code>| inputlookup ti_alert_outcomes.csv\n| where outcome=\"true_positive\"\n| lookup master_threat_intel indicator OUTPUT first_seen as ioc_first_seen\n| eval ioc_age_hours = (strptime(_time, \"%Y-%m-%d %H:%M:%S\") - strptime(ioc_first_seen, \"%Y-%m-%d\")) / 3600\n| stats avg(ioc_age_hours) as avg_detection_lag</code></pre>"
      },
      {
        "title": "Effectiveness Tracking",
        "body": "<h4>Weekly TI Report</h4><pre><code># Scheduled report: ti_weekly_metrics\n| makeresults\n| eval report_period = \"Last 7 days\"\n| appendcols [\n    search index=firewall earliest=-7d \n    | lookup master_threat_intel indicator as dest_ip OUTPUT threat_type \n    | where isnotnull(threat_type) \n    | stats count as ti_matches, dc(dest_ip) as unique_iocs_matched, dc(src_ip) as affected_hosts\n]\n| appendcols [\n    inputlookup master_threat_intel.csv \n    | stats count as total_active_iocs\n]\n| appendcols [\n    inputlookup ti_alert_outcomes.csv \n    | where strptime(resolution_date, \"%Y-%m-%d\") > relative_time(now(), \"-7d\")\n    | stats count as alerts_resolved, count(eval(outcome=\"true_positive\")) as true_positives\n]\n| eval coverage = round(unique_iocs_matched / total_active_iocs * 100, 2)\n| table report_period, total_active_iocs, ti_matches, unique_iocs_matched, affected_hosts, alerts_resolved, true_positives, coverage</code></pre><h4>Feed ROI Analysis</h4><pre><code>| inputlookup feed_costs.csv\n| join source [| inputlookup ti_alert_outcomes.csv | where outcome=\"true_positive\" | lookup master_threat_intel indicator OUTPUT sources | mvexpand sources | stats count as detections by sources | rename sources as source]\n| eval cost_per_detection = round(annual_cost / detections, 2)\n| sort cost_per_detection</code></pre><h4>Trend Analysis</h4><pre><code>| inputlookup ti_metrics_history.csv\n| timechart span=1w avg(hit_rate) as hit_rate, avg(tp_rate) as tp_rate\n| predict hit_rate as predicted_hit_rate future_timespan=4\n| predict tp_rate as predicted_tp_rate future_timespan=4</code></pre>"
      },
      {
        "title": "Operational Dashboards",
        "body": "<h4>TI Operations Dashboard Panels</h4><p><strong>Panel 1: Feed Health</strong></p><pre><code>| inputlookup feed_status.csv\n| eval status = if(last_update > relative_time(now(), \"-2h\"), \"healthy\", \"stale\")\n| stats count by status</code></pre><p><strong>Panel 2: IOC Coverage</strong></p><pre><code>| inputlookup master_threat_intel.csv\n| stats count by type\n| sort - count</code></pre><p><strong>Panel 3: Recent High-Confidence Hits</strong></p><pre><code>index=firewall earliest=-1h\n| lookup master_threat_intel indicator as dest_ip OUTPUT threat_type, confidence\n| where confidence=\"high\"\n| table _time, src_ip, dest_ip, threat_type\n| head 20</code></pre><p><strong>Panel 4: Alert Queue by Priority</strong></p><pre><code>index=notable status=\"new\" ti_confidence=*\n| stats count by priority\n| sort - priority</code></pre>"
      },
      {
        "title": "Continuous Improvement",
        "body": "<h4>Feedback Collection</h4><pre><code># When analyst closes alert\n| makeresults\n| eval indicator=\"192.168.50.100\", outcome=\"true_positive\", analyst=\"jsmith\", notes=\"Confirmed C2\", resolution_date=strftime(now(), \"%Y-%m-%d\")\n| outputlookup append=t ti_alert_outcomes.csv</code></pre><h4>Automated Feed Tuning</h4><pre><code># Identify feeds with high FP rate for review\n| inputlookup ti_alert_outcomes.csv\n| where outcome=\"false_positive\"\n| lookup master_threat_intel indicator OUTPUT sources\n| mvexpand sources\n| stats count as fp_count by sources\n| where fp_count > 10\n| outputlookup feeds_for_review.csv</code></pre><h4>IOC Retirement Automation</h4><pre><code># Retire stale IOCs\n| inputlookup master_threat_intel.csv\n| eval age_days = (now() - strptime(last_seen, \"%Y-%m-%d\")) / 86400\n| eval status = if(age_days > 90, \"retired\", \"active\")\n| where status=\"active\"\n| outputlookup master_threat_intel.csv</code></pre><h4>Quality Score Update</h4><pre><code># Boost confidence for validated IOCs\n| inputlookup ti_alert_outcomes.csv\n| where outcome=\"true_positive\"\n| stats count as tp_count by indicator\n| join indicator [| inputlookup master_threat_intel.csv]\n| eval confidence = case(\n    tp_count >= 3, \"high\",\n    tp_count >= 1, max(confidence, \"medium\"),\n    true(), confidence)\n| outputlookup master_threat_intel.csv</code></pre>"
      },
      {
        "title": "Summary",
        "body": "<p>Key TI workflow automation components:</p><ul><li><strong>Ingestion</strong>: Scheduled collection, validation, deduplication</li><li><strong>Enrichment</strong>: Multi-layer context from TI, geo, asset, user data</li><li><strong>Prioritization</strong>: Score-based ranking using TI confidence and context</li><li><strong>Response</strong>: Automated routing, SOAR integration, blocking recommendations</li><li><strong>Metrics</strong>: Hit rate, TP rate, feed effectiveness, detection lag</li><li><strong>Improvement</strong>: Feedback loops, automated tuning, IOC lifecycle management</li></ul><p>Automation transforms TI from a manual process to a measurable security capability.</p>"
      }
    ]
  }
}
