{
  "id": "inv-multi-source",
  "type": "tutorial",
  "title": "Multi-Source Correlation Techniques",
  "description": "Combine endpoint, network, identity, and application data using join, append, and lookup to build a complete picture of security incidents across your environment.",
  "category": "investigation",
  "difficulty": "intermediate",
  "duration": "25 min",
  "tags": ["investigation", "correlation", "join", "append", "intermediate"],
  "objectives": [
    "Combine data from multiple sources effectively",
    "Use join, append, and union for correlation",
    "Enrich events with lookup data",
    "Build comprehensive investigation views"
  ],
  "content": {
    "sections": [
      {
        "title": "The Challenge of Multi-Source Data",
        "body": "<p>Security data is scattered across many sources:</p><ul><li><strong>Endpoint</strong> - Windows events, Sysmon, EDR telemetry</li><li><strong>Network</strong> - Firewall, proxy, DNS, NetFlow</li><li><strong>Identity</strong> - Active Directory, IAM, VPN</li><li><strong>Application</strong> - Web apps, databases, SaaS logs</li><li><strong>Cloud</strong> - AWS CloudTrail, Azure AD, GCP audit logs</li></ul><p>Each source tells part of the story. Correlation reveals the full picture.</p><h4>Common Correlation Challenges</h4><ul><li>Different field names (user vs username vs account)</li><li>Different time formats</li><li>Different identifier formats (IP vs hostname)</li><li>Volume differences between sources</li></ul>"
      },
      {
        "title": "Append: Combining Results",
        "body": "<p>Append adds results from one search to another.</p><h4>Basic Append</h4><pre><code>index=security EventCode=4624 user=jsmith\n| append [search index=vpn user=jsmith]\n| append [search index=proxy user=jsmith]\n| table _time, index, user, src_ip, dest, action</code></pre><h4>Append with Field Normalization</h4><pre><code>index=security EventCode=4624\n| eval source=\"windows\", event_type=\"login\"\n| rename src_ip as source_ip\n| append [\n    search index=vpn action=success\n    | eval source=\"vpn\", event_type=\"vpn_login\"\n    | rename client_ip as source_ip\n]\n| append [\n    search index=proxy\n    | eval source=\"proxy\", event_type=\"web_request\"\n    | rename c_ip as source_ip\n]\n| table _time, source, event_type, user, source_ip, dest</code></pre><h4>When to Use Append</h4><ul><li>Combining similar events from different sources</li><li>Building unified timelines</li><li>Aggregating across indexes</li></ul>"
      },
      {
        "title": "Join: Correlating by Key",
        "body": "<p>Join links events from different searches by a common field.</p><h4>Basic Join</h4><pre><code>index=security EventCode=4624\n| join type=left user [\n    search index=hr_system\n    | table user, department, manager, hire_date\n]\n| table _time, user, department, manager, src_ip, dest</code></pre><h4>Join Types</h4><ul><li><strong>inner</strong> - Only matching records from both sides</li><li><strong>left</strong> - All from primary, matching from subsearch</li><li><strong>outer</strong> - All records from both sides</li></ul><h4>Multi-Field Join</h4><pre><code>index=firewall action=blocked\n| join type=left src_ip, dest_ip [\n    search index=threat_intel\n    | table indicator as src_ip, threat_type as src_threat\n]\n| join type=left dest_ip [\n    search index=threat_intel\n    | table indicator as dest_ip, threat_type as dest_threat\n]\n| where isnotnull(src_threat) OR isnotnull(dest_threat)\n| table _time, src_ip, src_threat, dest_ip, dest_threat</code></pre><h4>Join Limitations</h4><ul><li>Subsearch returns max 50,000 results by default</li><li>Can be slow with large datasets</li><li>Consider lookups for large reference data</li></ul>"
      },
      {
        "title": "Lookup: Enrichment at Scale",
        "body": "<p>Lookups are more efficient than joins for reference data.</p><h4>Basic Lookup Enrichment</h4><pre><code>index=security EventCode=4624\n| lookup user_directory user OUTPUT department, manager, is_admin\n| lookup asset_inventory dest as hostname OUTPUT asset_type, criticality, owner\n| table _time, user, department, dest, asset_type, criticality</code></pre><h4>Multiple Lookups</h4><pre><code>index=firewall action=allowed\n| lookup geoip src_ip OUTPUT src_country, src_city\n| lookup geoip dest_ip OUTPUT dest_country, dest_city\n| lookup threat_intel src_ip as indicator OUTPUT threat_score as src_score\n| lookup threat_intel dest_ip as indicator OUTPUT threat_score as dest_score\n| table _time, src_ip, src_country, src_score, dest_ip, dest_country, dest_score</code></pre><h4>Lookup for Classification</h4><pre><code>index=security EventCode=4624\n| lookup logon_type_reference Logon_Type OUTPUT description as logon_description, risk_level\n| where risk_level > 3\n| table _time, user, logon_description, risk_level</code></pre><h4>When to Use Lookup vs Join</h4><ul><li>Lookup: Reference data that doesn't change often (user info, asset inventory, threat intel)</li><li>Join: Dynamic data from other searches</li></ul>"
      },
      {
        "title": "Subsearch Correlation",
        "body": "<p>Subsearches filter results based on another search.</p><h4>Filter by Subsearch Results</h4><pre><code>index=firewall src_ip IN [\n    search index=security EventCode=4625\n    | stats count by src_ip\n    | where count > 10\n    | fields src_ip\n]\n| table _time, src_ip, dest_ip, action, bytes</code></pre><p>This finds firewall events from IPs that had >10 failed logins.</p><h4>Dynamic List Filtering</h4><pre><code>index=proxy\n| search dest IN [\n    search index=threat_intel category=\"malware\"\n    | fields indicator\n    | rename indicator as dest\n]\n| table _time, user, src_ip, dest, url</code></pre><h4>Format for IN Clause</h4><pre><code>index=security user IN [\n    search index=hr_system termination_date < now()\n    | fields user\n    | format\n]\n| stats count by user</code></pre><h4>Subsearch Limitations</h4><ul><li>Default max results: 10,000</li><li>Default max time: 60 seconds</li><li>Use `return` or `format` to control output</li></ul>"
      },
      {
        "title": "Correlation Patterns",
        "body": "<h4>Pattern 1: Alert Enrichment</h4><p>Add context to alerts with lookups and joins:</p><pre><code>index=alerts alert_name=\"Suspicious Login\"\n| join type=left user [search index=security EventCode=4624 earliest=-1h | stats count as recent_logins, dc(src_ip) as unique_sources by user]\n| lookup user_directory user OUTPUT department, manager\n| table _time, alert_name, user, department, recent_logins, unique_sources</code></pre><h4>Pattern 2: IOC Sweep</h4><p>Check multiple data sources for IOC presence:</p><pre><code>| inputlookup threat_iocs.csv\n| map search=\"index=* ($indicator$) earliest=-7d\"\n| stats count by indicator, index, sourcetype\n| where count > 0</code></pre><h4>Pattern 3: User Activity Summary</h4><pre><code>| inputlookup watchlist_users.csv\n| map maxsearches=100 search=\"\n    index=security OR index=proxy OR index=vpn user=$user$ earliest=-24h\n    | stats count as events, dc(index) as sources, values(index) as data_sources by user\"\n| table user, events, sources, data_sources</code></pre><h4>Pattern 4: Threat Intel Matching Across Sources</h4><pre><code>index=firewall OR index=proxy OR index=dns earliest=-24h\n| eval check_field = coalesce(dest_ip, dest, query)\n| lookup threat_intel indicator as check_field OUTPUT category, score\n| where isnotnull(category)\n| stats count by index, check_field, category, score\n| sort - score</code></pre>"
      },
      {
        "title": "Field Normalization Strategies",
        "body": "<h4>Standardize User Names</h4><pre><code>| eval user_normalized = lower(coalesce(\n    replace(user, \"(?i)domain\\\\\\\\\", \"\"),\n    replace(username, \"@company.com\", \"\"),\n    replace(account_name, \"(?i)domain\\\\\\\\\", \"\"),\n    \"unknown\"))</code></pre><h4>Standardize IP Fields</h4><pre><code>| eval src_ip = coalesce(src_ip, client_ip, c_ip, source_address, src)\n| eval dest_ip = coalesce(dest_ip, server_ip, s_ip, destination_address, dest)</code></pre><h4>Standardize Action Fields</h4><pre><code>| eval action_normalized = case(\n    action IN (\"allowed\", \"permit\", \"accept\", \"success\"), \"allowed\",\n    action IN (\"blocked\", \"denied\", \"drop\", \"reject\", \"failure\"), \"blocked\",\n    true(), action)</code></pre><h4>Create Composite Keys</h4><pre><code>| eval entity_key = lower(user) . \"|\" . src_ip\n| join type=left entity_key [search index=baseline | table entity_key, baseline_value]</code></pre>"
      },
      {
        "title": "Performance Optimization",
        "body": "<h4>Filter Early</h4><pre><code>index=security EventCode=4624 user=jsmith earliest=-24h\n| join user [search index=hr_system | fields user, department]</code></pre><p>Better than searching all security events then filtering.</p><h4>Use Stats Instead of Join When Possible</h4><p>Instead of:</p><pre><code>index=security EventCode=4624\n| join user [search index=security EventCode=4625 | stats count as failures by user]</code></pre><p>Use:</p><pre><code>index=security EventCode IN (4624, 4625)\n| stats count(eval(EventCode=4624)) as successes, count(eval(EventCode=4625)) as failures by user</code></pre><h4>Leverage tstats for Volume</h4><pre><code>| tstats count where index=security EventCode=4624 by user\n| join type=left user [search | inputlookup user_directory.csv | table user, department]</code></pre><h4>Cache Expensive Lookups</h4><p>For repeated investigations, create summary indexes:</p><pre><code>index=summary report=daily_user_activity\n| lookup user_directory user OUTPUT department</code></pre>"
      },
      {
        "title": "Building Complete Investigation Views",
        "body": "<h4>User Investigation Dashboard Query</h4><pre><code>| set user = \"jsmith\"\n| union\n    [search index=security EventCode IN (4624, 4625) user=$user$ earliest=-7d | eval source=\"auth\", detail=if(EventCode=4624, \"login\", \"failed\")]\n    [search index=sysmon EventCode=1 User=\"*$user$*\" earliest=-7d | eval source=\"process\", detail=Image]\n    [search index=proxy user=$user$ earliest=-7d | eval source=\"web\", detail=url]\n    [search index=vpn user=$user$ earliest=-7d | eval source=\"vpn\", detail=action]\n| lookup user_directory user OUTPUT department, manager\n| lookup geoip src_ip OUTPUT country, city\n| table _time, source, detail, src_ip, country, dest\n| sort _time</code></pre><h4>Incident Summary View</h4><pre><code>| makeresults\n| eval user=\"jsmith\", incident_time=strptime(\"2024-01-15 14:30\", \"%Y-%m-%d %H:%M\")\n| map search=\"\n    index=* user=$user$ earliest=$incident_time$-1h latest=$incident_time$+4h\n    | eval source=index\n    | stats count, earliest(_time) as first_event, latest(_time) as last_event, values(sourcetype) as data_types by source\n    | eval time_span = round((last_event - first_event) / 60, 1)\"\n| table source, count, time_span, data_types</code></pre><h4>Cross-Source Alert Correlation</h4><pre><code>index=alerts severity>=high earliest=-24h\n| join type=left user [\n    search index=security EventCode=4624 earliest=-24h\n    | stats dc(src_ip) as auth_sources, dc(dest) as systems_accessed by user\n]\n| join type=left user [\n    search index=proxy earliest=-24h\n    | stats dc(dest) as sites_visited, sum(bytes) as web_bytes by user\n]\n| table _time, alert_name, user, severity, auth_sources, systems_accessed, sites_visited, web_bytes</code></pre>"
      },
      {
        "title": "Summary",
        "body": "<p>Key multi-source correlation techniques:</p><ul><li><strong>Append</strong> - Stack results from multiple searches</li><li><strong>Join</strong> - Link events by common fields</li><li><strong>Lookup</strong> - Efficient enrichment with reference data</li><li><strong>Subsearch</strong> - Dynamic filtering based on other searches</li><li><strong>Field normalization</strong> - Standardize names across sources</li><li><strong>Composite keys</strong> - Create unique identifiers for correlation</li></ul><p>Effective multi-source correlation transforms siloed data into unified investigation views that reveal the complete attack narrative.</p>"
      }
    ]
  }
}
